<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<title>Improved Upload Server</title>

<style>
    ul{
        display:flex;
        list-style:none;
        margin:0%;
    }
    ul li{
        flex:1;
        background-color:aqua;
        margin:0 0 -1px -1px;
        border:1px solid black ;
    }
</style>

<head>
    <script>
        function getQueryVariable(variable){
            let query = window.location.search.substring(1);
            let vars = query.split("&");
            for (let i=0;i<vars.length;i++) {
                    let pair = vars[i].split("=");
                    if(pair[0] == variable){return pair[1];}
            }
            return(false);
        }

        function userMes(){
            const a = getQueryVariable("user");
            const b = getQueryVariable("passwd");
            document.getElementById('state3').innerHTML = a+b;
        }

        function getList() {
            
            var url="/upload/checkList?user="+getQueryVariable("user")+"&passwd="+getQueryVariable("passwd");
            var request = new XMLHttpRequest();
            request.open("GET",url);

            request.onload = function(){
                if (request.status == 200){
                    var pid = request.responseText;
                    document.getElementById('result').innerHTML = pid;
                }
            }
            request.send(null);       
        }

        function getDelete(filename) {            
            var url="/upload/delete?file="+filename+"&user="+getQueryVariable("user")+"&passwd="+getQueryVariable("passwd");
            var request = new XMLHttpRequest();
            request.open("GET",url);

            request.onload = function(){
                if (request.status == 200){
                    var pid = request.responseText;
                    document.getElementById('result').innerHTML = pid;
                }
            }
            request.send(null);
       
        }

        function upload(){
            var url="/upload/do?user="+getQueryVariable("user")+"&passwd="+getQueryVariable("passwd");
            var request = new XMLHttpRequest();
            var formData = new FormData();
            var file = document.getElementById('file_upload').files;

            for (var i=0; i<file.length; i++){
                formData.append("img", file[i]);
            }
            document.getElementById('state1').innerHTML = "正在上传";
            request.open("POST", url);
            
            request.upload.onloadstart = function () {
                stime = new Date().getTime();
                sloaded = 0;
            }
            request.upload.onprogress = function (evt) {
                let persent = ((evt.loaded / evt.total) * 100).toFixed(2);   
                
                document.getElementById("state1").innerHTML = persent + "%";

                let endTime = new Date().getTime();

                let dTime = (endTime - stime) / 1000; //毫秒换算成秒
                let dloaded = evt.loaded - sloaded;
                let speed = dloaded / dTime;

                stime = new Date().getTime();
                sloaded = evt.loaded;

                let unit = "b/s";
                if (speed / 1024 > 1) {
                    unit = "kb/s";
                    speed = speed / 1024;
                }

                if (speed / 1024 > 1) {
                    unit = "mb/s";
                    speed = speed / 1024;
                }
                document.getElementById("state2").innerHTML = speed.toFixed(2) + unit;
            }
            request.upload.onload = function () {
                document.getElementById('state1').innerHTML = "上传成功";
            }
            request.upload.onerror = function () {
                document.getElementById('state1').innerHTML ="上传失败";
            }

            request.send(formData);

            request.onload = function(){
                if (request.status == 200){
                    var pid = request.responseText;
                    document.getElementById('result').innerHTML = pid;
                }
                else{
                    var pid = request.responseText;
                    document.getElementById('state2').innerHTML = pid;
                }
            }
        }


    </script>
</head>

<body>

    <p id="result" align="center">暂无结果</p>

    <button align="center" type="button" id="check" onclick="getList()">查看static路径下文件</button>
    <p></p>
    
    <input type="file" id="file_upload" multiple/>
    <p></p>
    <button type="button" onclick="upload()">上传</button>

    <p id="state1"></p>
    <p id="state2"></p>

</body>

</html>